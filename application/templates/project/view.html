{% extends "base.html" %}
{%block head %}
{{super()}}
    <title>{{project.name}}</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/project-view.css')}}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/goSamples.css')}}">
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/1.6.7/go-debug.js"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='scripts/go-debug.js')}}"></script>
{% endblock %}

{%block content %}
<!-- modal -->
<div class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">افزودن کامپوننت</p>
            <button class="delete"></button>
        </header>
        <section class="modal-card-body">
            <div class="columns">
                <div class="column is-10">
                    <input class="input" placeholder="نام کامپوننت">
                </div>
                <div class="column is-2">
                    <input class="button" type="submit" value="جستجو">
                </div>
            </div>
            <div class="columns">
                <div class="column is-12">
                       {%for c in components_list%}
                    <div class="project">

                        <div class="columns">
                            <div class="column is-10">
                                <div class="name">{{c.name}}</div>
                                <div class="desc">نسخه  :
                                    {{c.deploy_version}}
                                </div>
                            </div>
                            <div class="column is-1">
                                <a class="button is-primary"
                                   href="{{url_for('component.view',cid=c.id)}}">جزئیات</a>
                            </div>

                            <div class="column is-2">
                                <a class="button is-primary"
                                   onclick="add_choice({{c.id}},'{{c.name}}')">add</a>
                            </div>

                        </div>
                    </div>
                       {%endfor%}
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <a href="{{url_for('component.create',pid=1)}}" class="button is-primary">ساخت کامپوننت جدید</a>
        </footer>
    </div>
</div>
<!-- content -->
<div class="column is-11-mobile is-8 is-offset-1 main">
    <br>
    <div class="columns">

        <div class="column rtl is-8">
            <h1 class="title">نام پروژه : {{project.name}}</h1>
        </div>
        <div class="column rtl is-3">
            <a href="{{url_for('project.list_projects')}}">بازگشت ></a>
        </div>
    </div>
    <div class="columns detail">
        <div class="column is-2">
            <img src="{{url_for('project.logo',pid=project.id)}}" alt="none">
            <button class="upload is-primary is-inverted button" onclick="document.getElementById('file').click(); return false;">آپلود عکس</button>
             <form id="frm" method=post action="{{url_for('project.upload_logo',pid=project.id)}}"
                  enctype="multipart/form-data">
                {{ form.logo_image(id="file", style="display:none") }}<br>
                {{form.csrf_token}}
                 <script type="text/javascript">
                 $(document).ready(function(){
                 $('#file').change(function(){
                 $('#frm').submit();});})
                </script>
            </form>
        </div>
        <div class="column is-8 is-offset-1">
            <div align="right" dir="rtl">
                <span>کلیدخصوصی : {{project.private_key}}</span>
            </div>
            <div align="right" dir="rtl"><span>پلن پروژه : طلائی</span> <span style="margin-right:1em;"><a
                    href="#"><i class="fa fa-pencil-square-o"> </i></a></span></div>
             <div align="right" dir="rtl">
                <span>تاریخ ساخت : {{project.create_date}}</span>
            </div>
            <div align="right" dir="rtl">
                <span>تاریخ شروع سرویس : </span><span class="start">95/11/3</span>
            </div>
            <div align="right" dir="rtl">
                <span>تاریخ پایان سرویس : </span><span class="exp">95/12/3</span>
            </div>
            <div align="right" dir="rtl">
                <form action="{{url_for('project.run_project',pid=project.id)}}" method="POST">

                    {% if running %}
                    <input style="min-width:150px;" class="button is-danger" type="submit" value="Stop">
                    {%else%}
                    <input style="min-width:150px;" class="button is-success" type="submit" value="Run">
                    {% endif %}

                </form>
            </div>
        </div>
    </div>
    <div class="columns components">
        <div class="column is-10">
            <div class="title">Project Logic</div>
            <div class="columns">
                <div class="column is-3">
                    <button class="is-primary button" onclick="save()" style="width: 100%;margin-bottom: 1em;">ذخیره
                    </button>
                    <button class="is-success button" style="width: 100%;" onclick="showPopup()">افزودن کامپوننت
                    </button>
                </div>
                <div  id="myDiagramDiv" class="column drag is-10 is-hidden-mobile">
                    
                </div>
                <div class="column drag is-10 is-hidden-desktop">
                    <button class="button is-success" onclick="newRow()">اضافه کردن سطر جدید</button>
                    <table id="define-logic">
                        {% for i in range(logic_view|length) %}
                        {% if logic_view[i][0].id and logic_view[i][1].id %}
                        <script>$(function () {
                                            newRow();
                                            var row=document.getElementById("define-logic").getElementsByTagName("tr")
                                            var sel=row[row.length-1-{{i}}].getElementsByTagName("select");
                                            for (op=0;op<sel[0].length;op++){
                                                if (sel[0].options[op].value=={{logic_view[i][0].id}}){
                                                    sel[0].options[op].selected=true;}}
                                            for (op=0;op<sel[1].length;op++){
                                                if (sel[1].options[op].value=={{logic_view[i][1].id }}){
                                                    sel[1].options[op].selected=true;}}});

                        </script>
                        {% elif logic_view[i][0].id %}
                        <script>$(function () {
                                            newRow();
                                            var row=document.getElementById("define-logic").getElementsByTagName("tr")
                                            var sel=row[row.length-1-{{i}}].getElementsByTagName("select");
                                            for (op=0;op<sel[0].length;op++){
                                                if (sel[0].options[op].value=={{logic_view[i][0].id}}){
                                                    sel[0].options[op].selected=true;}}});

                        </script>
                        {% else %}
                        <script>$(function () {
                                            newRow();
                                            var row=document.getElementById("define-logic").getElementsByTagName("tr")
                                            var sel=row[row.length-1-{{i}}].getElementsByTagName("select");
                                            for (op=0;op<sel[1].length;op++){
                                                if (sel[1].options[op].value=={{logic_view[i][1].id}}){
                                                    sel[1].options[op].selected=true;}}});

                        </script>

                        {% endif %}
                        {% endfor %}
                    </table>
                </div>
            </div>
            <div class="column is-2 ">

            </div>
        </div>
    </div>
</div>

{%endblock%}

{%block script %}
{{super()}}

function init() {
    if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
    var $ = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram =
      $(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
        {
          // start everything in the middle of the viewport
          initialContentAlignment: go.Spot.Center,
          // have mouse wheel events zoom in and out instead of scroll up and down
          "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
          // support double-click in background creating a new node
          // "clickCreatingTool.archetypeNodeData": { text: "new node" },
          // enable undo & redo
          "undoManager.isEnabled": true
        });

    // when the document is modified, add a "*" to the title and enable the "Save" button
    myDiagram.addDiagramListener("Modified", function(e) {
      var button = document.getElementById("SaveButton");
      if (button) button.disabled = !myDiagram.isModified;
      var idx = document.title.indexOf("*");
      if (myDiagram.isModified) {
        if (idx < 0) document.title += "*";
      } else {
        if (idx >= 0) document.title = document.title.substr(0, idx);
      }
    });

    // define the Node template
    myDiagram.nodeTemplate =
      $(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        // define the node's outer shape, which will surround the TextBlock
        $(go.Shape, "RoundedRectangle",
          {
            parameter1: 20,  // the corner has a large radius
            fill: $(go.Brush, "Linear", { 0: "#fff", 1: "#fff" }),
            stroke: "#0073AD",
            portId: "",  // this Shape is the Node's port, not the whole Node
            fromLinkable: true, fromLinkableSelfNode: false, fromLinkableDuplicates: true,
            toLinkable: true, toLinkableSelfNode: false, toLinkableDuplicates: true,
            cursor: "pointer"
          }),
        $(go.TextBlock,
          {
            margin:5,
            textAlign : "center",
            font: "bold 11pt helvetica, bold arial, sans-serif",
            editable: true  // editing the text automatically updates the model data
          },
          new go.Binding("text").makeTwoWay())
      );

    // unlike the normal selection Adornment, this one includes a Button
    myDiagram.nodeTemplate.selectionAdornmentTemplate =
      $(go.Adornment, "Spot",
        $(go.Panel, "Auto",
          $(go.Shape, { fill: null, stroke: "blue", strokeWidth: 2 }),
          $(go.Placeholder)  // a Placeholder sizes itself to the selected Node
        ),
        // the button to create a "next" node, at the top-right corner
        $("Button",
          {
            alignment: go.Spot.TopRight,
            click: addNodeAndLink  // this function is defined below
          },
          $(go.Shape, "PlusLine", { width: 6, height: 6 })
        ) // end button
      ); // end Adornment

    // clicking the button inserts a new node to the right of the selected node,
    // and adds a link to that new node
    function addNodeAndLink(e, obj) {
      var adornment = obj.part;
      var diagram = e.diagram;
      diagram.startTransaction("Add State");

      // get the node data for which the user clicked the button
      var fromNode = adornment.adornedPart;
      var fromData = fromNode.data;
      // create a new "State" data object, positioned off to the right of the adorned Node
      var toData = { text: "new" };
      var p = fromNode.location.copy();
      p.x += 200;
      toData.loc = go.Point.stringify(p);  // the "loc" property is a string, not a Point object
      // add the new node data to the model
      var model = diagram.model;
      model.addNodeData(toData);

      // create a link data from the old node data to the new node data
      var linkdata = {
        from: model.getKeyForNodeData(fromData),  // or just: fromData.id
        to: model.getKeyForNodeData(toData),
        text: "transition"
      };
      // and add the link data to the model
      model.addLinkData(linkdata);

      // select the new Node
      var newnode = diagram.findNodeForData(toData);
      diagram.select(newnode);

      diagram.commitTransaction("Add State");

      // if the new node is off-screen, scroll the diagram to show the new node
      diagram.scrollToRect(newnode.actualBounds);
    }

    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
      $(go.Link,  // the whole link panel
        {
          curve: go.Link.Bezier, adjusting: go.Link.Stretch,
          reshapable: true, relinkableFrom: true, relinkableTo: true,
          toShortLength: 3
        },
        new go.Binding("points").makeTwoWay(),
        new go.Binding("curviness"),
        $(go.Shape,  // the link shape
          { strokeWidth: 1.5 }),
        $(go.Shape,  // the arrowhead
          { toArrow: "standard", stroke: null }),
        $(go.Panel, "Auto",
          $(go.Shape,  // the label background, which becomes transparent around the edges
            {
              fill: $(go.Brush, "Radial",
                      { 0: "rgb(240, 240, 240)", 0.3: "rgb(240, 240, 240)", 1: "rgba(240, 240, 240, 0)" }),
              stroke: null
            }),
            $(go.Panel, "Auto",  // this whole Panel is a link label
                $(go.Shape, "rectangle", { fill: "yellow", stroke: "white" }),
                $(go.TextBlock, { margin: 1 , textAlign:"center"},
                  new go.Binding("text").makeTwoWay())
              )
          
        )
      );

    // read in the JSON data from the "mySavedModel" element
    load();
  }
  myNodes = { "nodeKeyProperty": "id",
      "nodeDataArray": [
        { "id": 0, "loc": "120 120", "text": "Initial" },
        { "id": 1, "loc": "330 120", "text": "First down" },
        { "id": 2, "loc": "226 376", "text": "First up" },
        { "id": 3, "loc": "60 276", "text": "Second down" },
        { "id": 4, "loc": "226 226", "text": "Wait" }
      ],
      "linkDataArray": [
        { "from": 0, "to": 0, "text": "up or timer", "curviness": -20 },
        { "from": 0, "to": 1, "text": "down", "curviness": 20 },
        { "from": 1, "to": 0, "text": "up (moved)\nPOST", "curviness": 20 },
        { "from": 1, "to": 1, "text": "down", "curviness": -20 },
        { "from": 1, "to": 2, "text": "up (no move)" },
        { "from": 1, "to": 4, "text": "timer" },
        { "from": 2, "to": 0, "text": "timer\nPOST" },
        { "from": 2, "to": 3, "text": "down" },
        { "from": 3, "to": 0, "text": "up\nPOST\n(dblclick\nif no move)" },
        { "from": 3, "to": 3, "text": "down or timer", "curviness": 20 },
        { "from": 4, "to": 0, "text": "up\nPOST" },
        { "from": 4, "to": 4, "text": "down" }
      ]
    };
  // Show the diagram's model in JSON format
  function save() {
    myNodes = myDiagram.model.toJson();
  }
  function load() {
    myDiagram.model = go.Model.fromJson(myNodes);
  }
  init();



var components_choices={{components_choices|safe}}
document.getElementsByClassName("submenu")[0].getElementsByTagName("li")[1].className="selected";
$(document).ajaxStop(function(){
window.location.reload();});
$(function() {

$( ".draggable" ).draggable({containment: "parent"});
$('img').error(function(){
$(this).hide()
});
});
$(function() {
$( "ul.droptrue" ).sortable({
items : "li:not('.info')",
connectWith: "ul",
change:function(){
$('button.accfood').removeAttr('disabled');

}
});
});
function showPopup(){
$('.modal').addClass('is-active');
}
$('.delete').click(function(){
$('.modal').removeClass('is-active');
});

    
function add_choice(cid,cname){
    components_choices.push({id: cid,name: cname});
    var row=document.getElementById("define-logic").getElementsByTagName("tr");
    for (i=0;i<row.length;i++){
    var sel = row[i].getElementsByTagName("select");
    if (sel.length!=0 ){
    for (j = 0; j < sel[0].length; ++j){
    if (sel[0].options[j].value == cid){
        return;}}
    var option = document.createElement("option");
    option.text = cname;
    option.value = cid;
    sel[0].options.add(option,0);
    var option = document.createElement("option");
    option.text = cname;
    option.value = cid;
    sel[1].options.add(option,0);
    }
    }

};
function newRow(){
var table=document.getElementById("define-logic")
var row = table.insertRow(0);
var comp1 = row.insertCell(0);
var comp2 = row.insertCell(1);
var msg = row.insertCell(2);
var comps=components_choices;

var sel_1= document.createElement("select");
var option = document.createElement("option");
option.text = "Input";
option.value = "";
sel_1.add(option,0);
for (i=0;i<comps.length;i++){
var option = document.createElement("option");
option.text = comps[i]["name"];
option.value = comps[i]["id"];
sel_1.add(option,0);
}
comp1.appendChild(sel_1);

var sel_2= document.createElement("select");
var option = document.createElement("option");
option.text = "Output";
option.value = "";
sel_2.add(option,0);
for (i=0;i
<comps.length;i++){
var option = document.createElement("option");
option.text = comps[i]["name"];
option.value = comps[i]["id"];
sel_2.add(option, 0);}
comp2.appendChild(sel_2);

var sel_3= document.createElement("select");
var option = document.createElement("option");
option.text = "BasicEvent";
option.value = "BasicEvent";
var top = sel_3.options[sel_3.selectedIndex];
sel_3.add(option, top);
msg.appendChild(sel_3);

};
function define(){
var project_id = {{project.id}}
var rel = []
var row=document.getElementById("define-logic").getElementsByTagName("tr")
for (i=0;i<row.length;i++){
var sel = row[i].getElementsByTagName("select");
if (sel.length!=0){
var comp1=sel[0].options[sel[0].selectedIndex].value
var comp2=sel[1].options[sel[1].selectedIndex].value
var msg=sel[2].options[sel[2].selectedIndex].value
rel.push({component_1_id: comp1,component_2_id: comp2,message_type: msg})}
}

var arr = { project_id: project_id,relations: rel};
$.ajax({
url: '/api/v1/project/logic',
type: 'POST',
data: JSON.stringify(arr),
contentType: 'application/json; charset=utf-8',
dataType: 'json',
async: false,
success: function(msg) {
}
});
};
{%endblock%}


